<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>YouTube Downloader</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">

<div class="w-full max-w-lg p-6 bg-white rounded-xl shadow-lg">
    <h1 class="text-2xl font-bold text-center mb-6">ğŸ“¥ YouTube Downloader</h1>

    <label class="block mb-2 font-semibold">YouTube URL</label>
    <input id="url" type="text" placeholder="Enter video URL"
           class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">

    <!-- Loading Spinner -->
    <div id="loading" class="hidden flex justify-center items-center mb-2">
        <svg class="animate-spin h-6 w-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
        </svg>
        <span class="ml-2 text-gray-600">Fetching video info...</span>
    </div>

    <!-- Error / Not Found Message -->
    <div id="errorMessage" class="hidden text-red-500 font-semibold text-center mb-4">
        ğŸ˜¢ Video not found or invalid URL
    </div>

    <!-- Video Info Preview -->
    <div id="videoInfo" class="hidden p-4 bg-gray-100 rounded-lg mb-4 text-center">
        <img id="thumbnail" class="mx-auto mb-2 rounded" width="320">
        <h2 id="videoTitle" class="font-semibold text-lg"></h2>
        <p id="videoUploader" class="text-sm text-gray-600 mb-4"></p>

        <!-- Download Buttons -->
        <div id="downloadButtons" class="space-x-4">
            <button onclick="startDownload('video')"
                    class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                â¬‡ï¸ Download Video
            </button>
            <button onclick="startDownload('audio')"
                    class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
                ğŸµ Download Audio
            </button>
        </div>
    </div>

    <!-- Progress Card -->
    <div id="progressCard" class="hidden p-4 bg-gray-100 rounded-lg mb-4">
        <p id="status" class="font-semibold mb-2">Status: Idle</p>
        <div class="w-full bg-gray-300 rounded-full h-4">
            <div id="bar" class="bg-blue-500 h-4 rounded-full w-0"></div>
        </div>
    </div>

    <!-- Download Link -->
    <div id="downloadLink" class="mt-4 hidden">
        <a id="fileLink" href="#" class="text-blue-600 font-bold hover:underline" target="_blank">
            ğŸ‰ Download Ready
        </a>
    </div>
</div>

<script>
let timeout;

// Real-time video info fetching with debounce
document.getElementById('url').addEventListener('input', () => {
    clearTimeout(timeout);
    timeout = setTimeout(() => {
        const url = document.getElementById('url').value;

        // Hide messages first
        document.getElementById('videoInfo').classList.add('hidden');
        document.getElementById('errorMessage').classList.add('hidden');

        if (!url) return;

        // Show loading
        document.getElementById('loading').classList.remove('hidden');

        fetch("/info", {
            method: "POST",
            headers: {"Content-Type": "application/x-www-form-urlencoded"},
            body: `url=${encodeURIComponent(url)}`
        })
        .then(res => res.json())
        .then(data => {
            // Hide loading
            document.getElementById('loading').classList.add('hidden');

            if (!data.error) {
                document.getElementById('videoInfo').classList.remove('hidden');
                document.getElementById('thumbnail').src = data.thumbnail;
                document.getElementById('videoTitle').innerText = data.title;
                document.getElementById('videoUploader').innerText = "By: " + data.uploader;
            } else {
                document.getElementById('errorMessage').classList.remove('hidden');
            }
        })
        .catch(err => {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('errorMessage').classList.remove('hidden');
            console.error(err);
        });
    }, 500);
});

function startDownload(dtype) {
    const urlInput = document.getElementById('url');
    const progressCard = document.getElementById('progressCard');
    const statusText = document.getElementById('status');
    const bar = document.getElementById('bar');
    const downloadLink = document.getElementById('downloadLink');

    // Reset UI
    progressCard.classList.remove('hidden');
    downloadLink.classList.add('hidden');
    bar.style.width = '0%';
    statusText.innerText = 'Status: Starting...';

    // Start download
    fetch("/download", {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: `url=${encodeURIComponent(urlInput.value)}&type=${dtype}`
    });

    // Listen to SSE progress
    const evt = new EventSource("/progress");
    evt.onmessage = e => {
        const data = JSON.parse(e.data);
        bar.style.width = data.percent + '%';
        statusText.innerText = `Status: ${data.status} | ${data.percent}%`;

        if (data.status === "done") {
            evt.close();
            statusText.innerText = "âœ… Download Completed!";
            const filePath = "/downloads/" + encodeURIComponent(data.filename);
            document.getElementById('fileLink').href = filePath;
            downloadLink.classList.remove('hidden');
        }

        if (data.status.startsWith("error")) {
            evt.close();
            statusText.innerText = "âŒ Error occurred: " + data.status;
        }
    };
}
</script>

</body>
</html>
